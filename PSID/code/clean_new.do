clear

do build/input/cross_year/cross_year.do

rename ER13002 intid1999
rename ER17002 intid2001
rename ER21002 intid2003
rename ER25002 intid2005
rename ER36002 intid2007
rename ER42002 intid2009
rename ER47302 intid2011
rename ER53002 intid2013
rename ER60002 intid2015
rename ER66002 intid2017

rename ER16515A1 cfood1999
rename ER16515A5 chousing1999
rename ER16515B6 ctransport1999
rename ER16515C9 ceduc1999
rename ER16515D1 cchild1999
rename ER16515D2 chealth1999

rename ER20456A1 cfood2001
rename ER20456A5 chousing2001
rename ER20456B6 ctransport2001
rename ER20456C9 ceduc2001
rename ER20456D1 cchild2001
rename ER20456D2 chealth2001

rename ER24138A1 cfood2003
rename ER24138A5 chousing2003
rename ER24138B6 ctransport2003
rename ER24138C9 ceduc2003
rename ER24138D1 cchild2003
rename ER24138D2 chealth2003

rename ER28037A1 cfood2005
rename ER28037A5 chousing2005
rename ER28037B7 ctransport2005
rename ER28037D1 ceduc2005
rename ER28037D2 cchild2005
rename ER28037D3 chealth2005

rename ER41027A1 cfood2007
rename ER41027A5 chousing2007
rename ER41027B7 ctransport2007
rename ER41027D1 ceduc2007
rename ER41027D2 cchild2007
rename ER41027D3 chealth2007

rename ER46971A1 cfood2009
rename ER52395A1 cfood2011
rename ER58212A1 cfood2013
rename ER65410 cfood2015
rename ER71487 cfood2017

rename ER46971A5 chousing2009
rename ER52395A5 chousing2011
rename ER58212A5 chousing2013
rename ER65414 chousing2015
rename ER71491 chousing2017

rename ER46971B7 ctransport2009
rename ER52395B7 ctransport2011
rename ER58212B7 ctransport2013
rename ER65425 ctransport2015
rename ER71503 ctransport2017

rename ER46971D1 ceduc2009
rename ER52395D1 ceduc2011
rename ER58212D1 ceduc2013
rename ER65437 ceduc2015
rename ER71515 ceduc2017

rename ER46971D2 cchild2009
rename ER52395D2 cchild2011
rename ER58212D2 cchild2013
rename ER65438 cchild2015
rename ER71516 cchild2017

rename ER46971D3 chealth2009
rename ER52395D3 chealth2011
rename ER58212D3 chealth2013
rename ER65439 chealth2015
rename ER71517 chealth2017

rename S411 stocks1999
rename S511 stocks2001
rename S611 stocks2003
rename S711 stocks2005
rename S811 stocks2007
rename ER46954 stocks2009
rename ER52358 stocks2011
rename ER58171 stocks2013
rename ER65368 stocks2015
rename ER71445 stocks2017

rename S417 wealth1999
rename S517 wealth2001
rename S617 wealth2003
rename S717 wealth2005
rename S817 wealth2007
rename ER46970 wealth2009
rename ER52394 wealth2011
rename ER58211 wealth2013
rename ER65408 wealth2015
rename ER71485 wealth2017

rename ER15020 cash1999
rename ER19216 cash2001
rename ER22596 cash2003
rename ER26577 cash2005
rename ER37595 cash2007
rename ER43586 cash2009
rename ER48911 cash2011
rename ER54661 cash2013
rename ER61772 cash2015
rename ER67826 cash2017

rename ER13041 house1999
rename ER17044 house2001
rename ER21043 house2003
rename ER25029 house2005
rename ER36029 house2007
rename ER42030 house2009
rename ER47330 house2011
rename ER53030 house2013

rename ER13047 mortrem1999
rename ER17052 mortrem2001
rename ER21051 mortrem2003
rename ER25042 mortrem2005
rename ER36042 mortrem2007
rename ER42043 mortrem2009
rename ER47348 mortrem2011
rename ER53048 mortrem2013

rename ER13049 mortratewhole1999
rename ER17056 mortratewhole2001
rename ER21055 mortratewhole2003
rename ER25046 mortratewhole2005
rename ER36046 mortratewhole2007
rename ER42047 mortratewhole2009
rename ER47355 mortratewhole2011
rename ER53055 mortratewhole2013

rename ER13050 mortratedecimal1999
rename ER17057 mortratedecimal2001
rename ER21056 mortratedecimal2003
rename ER25047 mortratedecimal2005
rename ER36047 mortratedecimal2007
rename ER42048 mortratedecimal2009
rename ER47356 mortratedecimal2011
rename ER53056 mortratedecimal2013

rename ER13051 yearobtmort1999
rename ER17058 yearobtmort2001
rename ER21057 yearobtmort2003
rename ER25048 yearobtmort2005
rename ER36049 yearobtmort2007
rename ER42050 yearobtmort2009
rename ER47357 yearobtmort2011
rename ER53057 yearobtmort2013

rename S420 homequity1999
rename S520 homequity2001
rename S620 homequity2003
rename S720 homequity2005
rename S820 homequity2007
rename ER46966 homequity2009
rename ER52390 homequity2011
rename ER58207 homequity2013

rename ER16463 earnings1999
rename ER20443 earnings2001
rename ER24116 earnings2003
rename ER27931 earnings2005
rename ER40921 earnings2007
rename ER46829 earnings2009
rename ER52237 earnings2011
rename ER58038 earnings2013
rename ER65216 earnings2015
rename ER71293 earnings2017

rename ER13010 ageh1999
rename ER17013 ageh2001
rename ER21017 ageh2003
rename ER25017 ageh2005
rename ER36017 ageh2007
rename ER42017 ageh2009
rename ER47317 ageh2011
rename ER53017 ageh2013
rename ER60017 ageh2015
rename ER66017 ageh2017

rename ER16518 lwgt1999
rename ER20394 lwgt2001
rename ER24179 lwgt2003
rename ER28078 lwgt2005
rename ER41069 lwgt2007
rename ER47012 lwgt2009
rename ER52436 lwgt2011
rename ER58257 lwgt2013
rename ER65492 lwgt2015
rename ER71570 lwgt2017

rename ER13006 month1999
rename ER17009 month2001
rename ER21012 month2003
rename ER25012 month2005
rename ER36012 month2007
rename ER42012 month2009
rename ER47312 month2011
rename ER53012 month2013
rename ER60012 month2015
rename ER66012 month2017

rename ER16516 educ1999
rename ER20457 educ2001
rename ER24148 educ2003
rename ER28047 educ2005
rename ER41037 educ2007
rename ER46981 educ2009
rename ER52405 educ2011
rename ER58223 educ2013
rename ER65459 educ2015
rename ER71538 educ2017

drop ER*

gen famid = _n

#delimit ;
reshape long intid stocks wealth cash house mortrem mortratewhole
	mortratedecimal yearobtmort homequity earnings ageh lwgt
	cfood chousing ctransport ceduc cchild chealth
	educ month,
	i(famid) j(year);
#delimit cr

gen consumption = cfood + chousing + ctransport + ceduc + cchild + chealth

sort famid year
order famid year
drop if missing(intid)

replace cash = . if (cash == 999999998) | (cash == 999999999)
replace age = . if (age == 999)
replace mortratewhole = . if (mortratewhole == 98) | (mortratewhole == 99)
replace mortratedecimal = . if (mortratedecimal == 998) | (mortratedecimal == 999)
replace house = . if (house == 9999998) | (house == 9999999)
replace mortrem = . if (mortrem == 9999998) | (mortrem == 9999999)
replace yearobtmort = . if (yearobtmort == 9998) | (yearobtmort == 9999)
replace educ = . if (educ == 99)

gen imort = mortratewhole / 100 + mortratedecimal / 100000
drop mortrate*

drop if !inrange(age, 25, 55)
drop if stocks < 0

gen has_stocks = stocks > 0
bysort famid: egen ever_had_stocks = max(has_stocks)
bysort famid: egen nyears = count(stocks)

gen liquid = stocks + cash
gen stshare = stocks / liquid if liquid > 0 & !missing(liquid)
gen cond_stshare = stshare if stocks > 0 & !missing(stocks)

gen period = .
local ip = 1
gen qwealth = .
forvalues yr = 1999(2)2017 {
	replace period = `ip' if year ==  `yr'
	xtile qtemp = wealth [aw=lwgt] if year == `yr', nquantiles(5)
	replace qwealth = qtemp if year == `yr'
	drop qtemp
	local ip = `ip' + 1
}
tsset famid period
gen entered_stocks = (stocks > 0) & (L.stocks == 0) if !missing(stocks, L.stocks)
gen left_stocks = (stocks == 0) & (L.stocks > 0) if !missing(stocks, L.stocks)

gen homeowner = (house > 0) & !missing(house)

* Merge with pce
merge m:1 year month using "../SurveyOfConsumers/build/output/pce.dta", nogen keep(1 3)
gen ptemp = pce if (year == 2015) & (month == 10)
egen price2015 = max(ptemp)
drop ptemp

gen pricelev = pce / price2015
drop pce price2015

local nomvars consumption wealth stocks earnings
foreach nvar of local nomvars {
	replace `nvar' = `nvar' / pricelev
}

save build/output/output.dta, replace
